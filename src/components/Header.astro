---
import LangSwitcher from './LangSwitcher.astro';

const { lang = 'fr' } = Astro.props;

const t =
  {
    fr:{home:'Accueil',services:'Services',cases:'Cas',about:'À propos',blog:'Blog',contact:'Contact',menu:'ALEXIS FISKA',search:'Rechercher…',results:'Résultats',nores:'Aucun résultat',ctaAudit:'Réserver un audit gratuit de 30 min'},
    en:{home:'Home',services:'Services',cases:'Cases',about:'About',blog:'Blog',contact:'Contact',menu:'ALEXIS FISKA',search:'Search…',results:'Results',nores:'No results',ctaAudit:'Book a free 30-min audit'},
    de:{home:'Startseite',services:'Dienstleistungen',cases:'Referenzen',about:'Über mich',blog:'Blog',contact:'Kontakt',menu:'ALEXIS FISKA',search:'Suchen…',results:'Ergebnisse',nores:'Keine Ergebnisse',ctaAudit:'Kostenloses 30-Min-Audit buchen'},
    pt:{home:'Início',services:'Serviços',cases:'Projetos',about:'Sobre',blog:'Blog',contact:'Contato',menu:'ALEXIS FISKA',search:'Pesquisar…',results:'Resultados',nores:'Sem resultados',ctaAudit:'Agendar auditoria gratuita de 30 min'},
  }[lang] ?? {home:'Accueil',services:'Services',cases:'Cas',about:'À propos',blog:'Blog',contact:'Contact',menu:'Menu',search:'Rechercher…',results:'Résultats',nores:'Aucun résultat',ctaAudit:'Réserver un audit gratuit de 30 min'};

const items = [
  { href: `/${lang}`, label: t.home },
  { href: `/${lang}/services`, label: t.services },
  { href: `/${lang}/cases`, label: t.cases },
  { href: `/${lang}/about`, label: t.about },
  { href: `/${lang}/blog`, label: t.blog },
  { href: `/${lang}/contact`, label: t.contact },
];

const current = (Astro.url?.pathname ?? '/').replace(/\/$/, '');
const isActive = (href) => {
  const h = href.replace(/\/$/, '');
  if (h === `/${lang}`) return current === h;
  return current.startsWith(h);
};

const BASE = import.meta.env.BASE_URL ?? '/';
---
<header
  id="site-header"
  data-nores={t.nores}
  class="sticky top-0 z-[200] isolate border-b border-white/10 bg-black/90 backdrop-blur transition-shadow"
>
  <div class="container mx-auto px-4">
    <div class="h-16 flex items-center gap-3">
<!-- Brand (noir & blanc, ultra luxe) -->
<a
  href={`/${lang}`}
  aria-label={t.home}
  class="group relative inline-flex items-center gap-2 rounded-lg px-2 py-1
         focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40"
>
  <span class="relative inline-block leading-none pb-2">
    <span
      class="text-white uppercase font-semibold md:font-bold tracking-[0.08em]
             text-[1rem] md:text-[1.75rem]"
      style="font-family: 'Poppins'; font-feature-settings:'kern','liga','calt';"
    >
      Alexis&nbsp;Fiska
    </span>

</a>


</style>


      <!-- Desktop NAV -->
      <nav class="hidden md:flex items-center gap-2 ml-6" aria-label="Primary">
        {items.map((it) => (
          <a
            href={it.href}
            class={`relative rounded-lg px-3 py-2 text-sm font-medium transition-colors
                    hover:text-[#D6B36A] hover:bg-white/5
                    ${isActive(it.href) ? 'text-white' : 'text-white/80'}`}
          >
            {it.label}
            {isActive(it.href) && <span class="absolute left-3 right-3 -bottom-[2px] h-[2px] rounded bg-[#fff]"></span>}
          </a>
        ))}
      </nav>

      <div class="hidden md:block flex-1"></div>

      <!-- Desktop SEARCH + Lang -->
      <div class="hidden md:flex items-center gap-3">
        <div class="relative">
          <input
            id="search-desktop"
            type="search"
            placeholder={t.search}
            class="w-64 focus:w-80 transition-all rounded-full bg-white/5
                   border border-white/15 pl-9 pr-4 py-2 text-sm text-white placeholder-white/50 outline-none
                   focus:ring-2 ring-[#fff] shadow-sm"
            autocomplete="off"
            aria-label={t.search}
            data-index-url={`${BASE}search.json`}
            data-lang={lang}
          />
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 opacity-90 text-white/80" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
            <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>

        <!-- Résultats desktop -->
        <div
          id="search-desktop-results"
          class="hidden fixed z-[1000] rounded-xl border border-white/10 bg-neutral-950 shadow-2xl overflow-hidden
                 opacity-0 scale-95 translate-y-1 pointer-events-none
                 transition duration-150 ease-out [transition-property:opacity,transform]"
          style="left:0;top:0;width:24rem"
        >
          <div class="px-4 py-2 text-[11px] uppercase tracking-wider text-white/80">{t.results}</div>
          <ul class="max-h-96 overflow-auto divide-y divide-white/10" role="listbox" aria-label={t.results}></ul>
          <div class="px-4 py-2 text-[11px] text-white/60 bg-black/30">
            ↵ pour ouvrir — Échap pour fermer
          </div>
        </div>

        <LangSwitcher currentLang={lang} />
        <button class="hidden md:inline-flex pointer-events-none opacity-0 p-2">
          <svg width="22" height="22" viewBox="0 0 24 24" class="text-white/80" fill="none" aria-hidden="true">
            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Mobile right -->
      <div class="md:hidden ml-auto flex items-center gap-2">
        <LangSwitcher currentLang={lang} />
        <button
          id="menu-open"
          class="inline-flex items-center justify-center rounded-lg p-2 hover:bg-white/10 text-white"
          aria-label="Ouvrir le menu" aria-haspopup="dialog" aria-controls="mobile-menu" aria-expanded="false">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- MOBILE DRAWER -->
  <div id="mobile-menu" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-title"
       aria-hidden="true" class="hidden fixed inset-0 z-[60]">
    <div id="menu-backdrop" class="absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-300 ease-out"></div>
    <section id="menu-panel"
      class="absolute inset-0 h-[100dvh] w-screen bg-neutral-950 shadow-2xl ring-1 ring-white/10
             flex flex-col transform-gpu translate-x-full transition-transform duration-300 ease-out overscroll-contain text-white"
    >
      <!-- Top bar -->
      <div class="h-14 w-full px-4 flex items-center justify-between border-b border-white/10">
        <span id="mobile-menu-title" class="text-xs uppercase tracking-wide text-white/60">{t.menu}</span>
        <button id="menu-close" class="inline-flex items-center justify-center rounded-lg p-2 hover:bg-white/10" aria-label="Fermer le menu">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6l-12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>

      <!-- Mobile search -->
      <div class="px-4 pt-3">
        <div class="relative">
          <input
            id="search-mobile"
            type="search"
            placeholder={t.search}
            class="w-full rounded-full bg-white/5 border border-white/10 pl-9 pr-4 py-3 text-[15px] text-white placeholder-white/50 outline-none focus:ring-2 ring-[#D6B36A40] shadow-sm"
            autocomplete="off"
            aria-label={t.search}
            data-index-url={`${BASE}search.json`}
            data-lang={lang}
          />
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 opacity-70 text-white/80" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
            <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>

          <div id="search-mobile-results"
               class="hidden absolute z-[300] mt-2 w-full left-0 rounded-xl border border-white/10 bg-neutral-950 shadow-2xl overflow-hidden">
            <div class="px-4 py-2 text-[11px] uppercase tracking-wider text-white/70">{t.results}</div>
            <ul class="max-h-96 overflow-auto divide-y divide-white/10" role="listbox" aria-label={t.results}></ul>
          </div>
        </div>
      </div>

      <!-- Links (scroll area) -->
      <nav class="px-4 py-3 grow overflow-y-auto" aria-label="Mobile">
        <ul class="space-y-1">
          {items.map((it) => (
            <li>
              <a href={it.href}
                class={`block rounded-xl px-3 py-3 text-[16px] font-medium
                        hover:bg-white/5 hover:text-[#D6B36A]
                        ${isActive(it.href) ? 'bg-white/10 text-white' : 'text-white/90'}`}>
                {it.label}
              </a>
            </li>
          ))}
        </ul>
      </nav>

      <!-- Bottom action card -->
      <div class="mt-auto p-4 border-t border-white/10 bg-white/[.03] backdrop-blur-sm">
        <a
          href={`/${lang}/contact#audit`}
          class="inline-flex w-full items-center justify-center gap-2 rounded-xl px-4 py-3
                 border border-[#D6B36A80] bg-transparent hover:bg-[#D6B36A14]
                 text-white font-medium transition-colors"
        >
          {t.ctaAudit}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>

        <div class="mt-3 flex items-center justify-between">
          <LangSwitcher currentLang={lang} />
          <div class="flex items-center gap-3">
            <a href="mailto:alexissfiska@gmail.com" class="p-2 rounded-lg hover:bg-white/10" aria-label="Email">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 6h16v12H4z" stroke="currentColor" stroke-width="2"/><path d="M4 7l8 6 8-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </a>
            <a href="https://www.linkedin.com/in/alexis-fiska" target="_blank" rel="noopener" class="p-2 rounded-lg hover:bg-white/10" aria-label="LinkedIn">
              <svg class="block" viewBox="0 0 93 93" width="18" height="18" fill="currentColor" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                <g><g>
                  <path d="M11.185,0.08C5.004,0.08,0.001,5.092,0,11.259c0,6.173,5.003,11.184,11.186,11.184c6.166,0,11.176-5.011,11.176-11.184 C22.362,5.091,17.351,0.08,11.185,0.08z"></path>
                  <rect x="1.538" y="30.926" width="19.287" height="62.054"></rect>
                  <path d="M69.925,29.383c-9.382,0-15.673,5.144-18.248,10.022h-0.258v-8.479H32.921v62.053h19.27V62.281 c0-8.093,1.541-15.932,11.575-15.932c9.89,0,10.022,9.256,10.022,16.451v30.178H93.06V58.942 C93.06,42.235,89.455,29.383,69.925,29.383z"></path>
                </g></g>
              </svg>
            </a>
            <a href="https://x.com/FiskaAlexis" target="_blank" rel="noopener" class="p-2 rounded-lg hover:bg-white/10" aria-label="X">
              <svg width="18" height="18" viewBox="0 0 300 300" fill="currentColor" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                <path d="m236 0h46l-101 115 118 156h-92.6l-72.5-94.8-83 94.8h-46l107-123-113-148h94.9l65.5 86.6zm-16.1 244h25.5l-165-218h-27.4z"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </section>
  </div>

  <style is:inline>
    .search-mark{ background:rgba(214,179,106,.25); padding:0 .15rem; border-radius:.25rem }
    @media (prefers-reduced-motion:no-preference){
      #site-header.is-scrolled{ box-shadow:0 6px 24px rgba(0,0,0,.35) }
    }
  </style>

  <script is:inline>
    (function () {
      // ===== Header shadow on scroll =====
      var sh = document.getElementById('site-header');
      var last = 0;
      function onScroll(){
        var y = window.scrollY || document.documentElement.scrollTop || 0;
        if ((y>2) !== (last>2)) sh && sh.classList.toggle('is-scrolled', y>2);
        last = y;
      }
      onScroll();
      window.addEventListener('scroll', onScroll, { passive: true });

      // ===== Drawer (mobile) =====
      var root = document.getElementById('mobile-menu');
      var openBtn = document.getElementById('menu-open');
      var closeBtn = document.getElementById('menu-close');
      var backdrop = document.getElementById('menu-backdrop');
      var panel = document.getElementById('menu-panel');
      if (root && openBtn && closeBtn && backdrop && panel) {
        function open() {
          root.classList.remove('hidden');
          root.setAttribute('aria-hidden', 'false');
          openBtn.setAttribute('aria-expanded', 'true');
          document.documentElement.classList.add('overflow-hidden');
          panel.getBoundingClientRect();
          requestAnimationFrame(function () {
            backdrop.classList.add('opacity-100');
            panel.classList.remove('translate-x-full');
          });
          panel.querySelectorAll('a[href]').forEach(function (a) { a.addEventListener('click', close, { once: true }); });
        }
        function close() {
          backdrop.classList.remove('opacity-100');
          panel.classList.add('translate-x-full');
          openBtn.setAttribute('aria-expanded', 'false');
          document.documentElement.classList.remove('overflow-hidden');
          var done = function () {
            root.classList.add('hidden');
            root.setAttribute('aria-hidden', 'true');
            panel.removeEventListener('transitionend', done);
            if (openBtn.focus) openBtn.focus();
          };
          panel.addEventListener('transitionend', done, { once: true });
        }
        openBtn.addEventListener('click', open);
        closeBtn.addEventListener('click', close);
        backdrop.addEventListener('click', close);
      }

      // ===== Search (desktop + mobile) =====
      var cache = null, controller = null;
      function escHtml(s){ return (s||'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function escRx(s){ return s.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&'); }
      function highlight(text, q){
        var t = escHtml(text||'');
        if(!q) return t;
        try{ var rx = new RegExp('('+escRx(q)+')','ig'); return t.replace(rx,'<mark class="search-mark">$1</mark>'); }
        catch(_){ return t; }
      }

      function setupSearch(inputId, resultsBoxId, emptyLabel){
        var input = document.getElementById(inputId);
        var box = document.getElementById(resultsBoxId);
        if(!input || !box) return;
        var list = box.querySelector('ul');
        var lang = input.dataset.lang || 'fr';
        var indexUrl = input.dataset.indexUrl || '/search.json';
        var debTimer = null, opened = false;

        function positionBox(){
          var r = input.getBoundingClientRect();
          var gap = 8, minW = Math.max(320, r.width), maxW = Math.min(512, window.innerWidth - 16);
          var w = Math.max(Math.min(maxW, minW), 320);
          var left = Math.min(r.left, window.innerWidth - w - 8), top  = r.bottom + gap;
          box.style.width = w + 'px'; box.style.left  = left + 'px'; box.style.top   = top  + 'px';
        }

        function render(items, q){
          list.innerHTML = '';
          if(!items.length){
            var li = document.createElement('li');
            li.className = 'px-4 py-4 text-sm text-white/60';
            li.textContent = emptyLabel; list.appendChild(li); return;
          }
          items.forEach(function (it){
            var badgeCls = 'inline-flex items-center text-[10px] px-2 py-[2px] rounded-full border border-white/10 bg-white/5 text-white/70';
            var li = document.createElement('li');
            li.innerHTML =
              '<a href="'+ it.url +'" class="flex gap-3 items-start px-4 py-3 hover:bg-white/5 transition">' +
                '<div class="mt-[2px] text-white/80">' +
                  (it.type==='blog'
                    ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M5 5h14v14H5z" stroke="currentColor" stroke-width="2"/><path d="M8 9h8M8 13h8M8 17h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>'
                    : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 3h10l4 4v14H7z" stroke="currentColor" stroke-width="2"/><path d="M7 3v18H3V7l4-4z" stroke="currentColor" stroke-width="2"/></svg>') +
                '</div>' +
                '<div class="min-w-0">' +
                  '<div class="flex items-center gap-2">' +
                    '<div class="text-sm font-semibold text-white">' + highlight(it.title, q) + '</div>' +
                    '<span class="'+ badgeCls +'">'+ (it.type==='blog' ? 'Blog' : 'Page') +'</span>' +
                  '</div>' +
                  '<div class="text-xs text-white/70 mt-1 overflow-hidden">' + highlight(it.description||'', q) + '</div>' +
                '</div>' +
                '<div class="ml-auto opacity-60 text-white/80"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>' +
              '</a>';
            list.appendChild(li);
          });
        }

        function ensureIndex(url){
          if (cache) return Promise.resolve(cache);
          if (controller) controller.abort();
          controller = new AbortController();
          return fetch(url, { signal: controller.signal }).then(function(r){ return r.json(); }).then(function(j){ cache = j; return j; });
        }

        function showBox(){
          positionBox(); box.classList.remove('hidden'); box.getBoundingClientRect();
          box.classList.remove('opacity-0','scale-95','translate-y-1','pointer-events-none');
          box.classList.add('opacity-100','scale-100','translate-y-0','pointer-events-auto'); opened = true;
        }

        function hideBox(){
          box.classList.add('opacity-0','scale-95','translate-y-1','pointer-events-none');
          box.classList.remove('opacity-100','scale-100','translate-y-0','pointer-events-auto');
          var done = function(){ box.classList.add('hidden'); box.setAttribute('aria-hidden','true'); box.removeEventListener('transitionend', done); };
          box.addEventListener('transitionend', done, { once:true }); opened = false;
        }

        input.addEventListener('input', function(){
          var q = input.value.trim(); if (debTimer) window.clearTimeout(debTimer); if (!q){ if (opened) hideBox(); return; }
          debTimer = window.setTimeout(function(){
            ensureIndex(indexUrl).then(function(data){
              var n = (q||'').toLowerCase();
              var res = (data.items || [])
                .filter(function (it) { return it.lang === lang; })
                .filter(function (it) {
                  var hay = (it.title + ' ' + (it.description || '')).toLowerCase();
                  return hay.indexOf(n) !== -1;
                }).slice(0, 8);
              render(res, q); showBox();
            }).catch(function(){ render([], q); showBox(); });
          }, 120);
        });
        input.addEventListener('keydown', function(e){ if(e.key === 'Escape' && opened) hideBox(); });
        input.addEventListener('focus', function(){ if (input.value.trim()) showBox(); });
        input.addEventListener('blur', function(){ setTimeout(function(){ if(opened) hideBox(); }, 120); });
        window.addEventListener('resize', function(){ if(opened) positionBox(); });
        window.addEventListener('scroll', function(){ if(opened) positionBox(); }, { passive:true });
      }

      var EMPTY = (document.getElementById('site-header')?.dataset?.nores) || 'Aucun résultat';
      setupSearch('search-desktop', 'search-desktop-results', EMPTY);
      setupSearch('search-mobile', 'search-mobile-results', EMPTY);
    })();
  </script>
</header>
