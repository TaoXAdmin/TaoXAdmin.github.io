---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

type BlogEntry = CollectionEntry<'blog'>;

export async function getStaticPaths() {
  const posts: BlogEntry[] = await getCollection(
    'blog',
    (entry) => entry.slug.endsWith('.fr') && !entry.data.draft
  );
  return posts.map((post) => ({
    params: { slug: post.slug.replace(/\.(fr|en|de|pt)$/, '') },
    props: { post },
  }));
}

const { post } = Astro.props as { post: BlogEntry };
const { Content } = await post.render();

const lang = 'fr';
const pageTitle = `${post.data.title} - Alexis Fiska`;
const pageDescription = post.data.description ?? '';

const locale = 'fr-FR';
const fmtDate = (d: Date) =>
  new Date(d).toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' });

const pathname = Astro.url?.pathname ?? '/';
const canonical = new URL(pathname, Astro.site).toString();

const tags: string[] = Array.isArray(post.data.tags) ? post.data.tags : [];
const BASE = import.meta.env.BASE_URL ?? '/';
---
<BaseLayout lang={lang} title={pageTitle} description={pageDescription}>
  <header class="max-w-3xl mx-auto mt-6 mb-8 text-center">
    {tags.length > 0 && (
      <ul class="mb-3 flex flex-wrap justify-center gap-2">
        {tags.map((t) => (
          <li class="text-[11px] px-2.5 py-1 rounded-full
                     border border-[#D6B36A40] bg-white/[.03] text-white">
            {t}
          </li>
        ))}
      </ul>
    )}
    <h1 class="text-3xl md:text-4xl font-bold leading-tight text-white">
      <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-[#D6B36A]">
        {post.data.title}
      </span>
    </h1>
    {pageDescription && (
      <p class="mt-3 text-white/70">{pageDescription}</p>
    )}
    <p class="mt-3 text-sm text-white/60">
      Publié le <time datetime={post.data.date.toISOString()}>{fmtDate(post.data.date)}</time>
    </p>
  </header>

  <div class="max-w-3xl mx-auto mb-10">
    <div class="h-px w-full bg-gradient-to-r from-transparent via-[#D6B36A33] to-transparent mb-8"></div>

    <!-- Prose luxe -->
    <article
      class="prose prose-invert max-w-none
             prose-headings:text-white prose-strong:text-white
             prose-a:text-[#D6B36A] prose-a:no-underline hover:prose-a:underline prose-a:underline-offset-4
             prose-hr:border-white/10
             prose-blockquote:border-l-[#D6B36A66] prose-blockquote:text-white/80
             prose-code:text-white prose-pre:bg-white/5 prose-pre:border prose-pre:border-white/10
             prose-li:marker:text-[#D6B36A99]">
      <Content />
    </article>

    <footer class="mt-10 space-y-6">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
        <a
          href={`/fr/blog`}
          class="inline-flex items-center gap-2 text-white hover:text-[#D6B36A] focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40 rounded-lg px-1"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M20 12H4M10 6l-6 6 6 6" stroke="currentColor" stroke-width="2" fill="none" />
          </svg>
          Retour au blog
        </a>

        <div class="flex items-center gap-2 text-sm">
          <span class="text-white/70">Partager</span>
          <a
            class="px-2 py-1 rounded-lg border border-[#D6B36A40] text-white hover:bg-[#D6B36A14]"
            href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(canonical)}&text=${encodeURIComponent(post.data.title)}`}
            target="_blank" rel="noopener"
            aria-label="Partager sur X/Twitter"
          >X</a>
          <a
            class="px-2 py-1 rounded-lg border border-[#D6B36A40] text-white hover:bg-[#D6B36A14]"
            href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(canonical)}`}
            target="_blank" rel="noopener"
            aria-label="Partager sur LinkedIn"
          >LinkedIn</a>
        </div>
      </div>

      <div class="rounded-2xl border border-white/10 p-5 bg-neutral-950 shadow-lg shadow-black/20">
        <div class="flex items-center gap-4">
          <img src={`${BASE}images/profile.jpg`} alt="Portrait d’Alexis Fiska"
               class="w-12 h-12 rounded-full object-cover ring-1 ring-[#D6B36A33]" loading="lazy" />
          <div>
            <p class="font-semibold text-white">Alexis Fiska</p>
            <p class="text-sm text-white/70">Lead QA Automation &amp; GenAI — missions en France/remote.</p>
          </div>
        </div>
      </div>
    </footer>
  </div>
</BaseLayout>
